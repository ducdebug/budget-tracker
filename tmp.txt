/* ====== REAL APP CODE â€” uncomment everything below and delete the maintenance block above to restore ======

'use client';

import { useState, useEffect, useCallback } from 'react';
import { Header } from '@/components/header';
import { BalanceCard } from '@/components/balance-card';
import { CoupleOverview } from '@/components/couple-overview';
import { RecentActivities } from '@/components/recent-activities';
import { BottomNav } from '@/components/bottom-nav';
import { AddTransactionDrawer } from '@/components/add-transaction-drawer';
import { BudgetOverview } from '@/components/budget-overview';
import { DebtItem, AddDebtDrawer } from '@/components/debt-tracker';
import { SettingsPanel } from '@/components/settings-panel';
import { CategoryManager } from '@/components/category-manager';
import { TransactionHistory } from '@/components/transaction-history';
import {
  getUsersSummary,
  getRecentTransactions,
  getCategories,
  getBudgetStatus,
  getDebts,
  resolveDebt,
} from '@/lib/actions';
import { getUserProfile } from '@/lib/auth-actions';
import type {
  UserFinanceSummary,
  Transaction,
  Category,
  BudgetStatus,
  Debt,
  User,
} from '@/lib/types';

export default function Dashboard() {
  // â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [activeTab, setActiveTab] = useState('home');
  const [showAddTx, setShowAddTx] = useState(false);
  const [showAddDebt, setShowAddDebt] = useState(false);
  const [showHistory, setShowHistory] = useState(false);

  const [summaries, setSummaries] = useState<UserFinanceSummary[]>([]);
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [categories, setCategories] = useState<Category[]>([]);
  const [budgets, setBudgets] = useState<BudgetStatus[]>([]);
  const [debts, setDebts] = useState<Debt[]>([]);
  const [users, setUsers] = useState<User[]>([]);
  const [currentUserId, setCurrentUserId] = useState<string>('');

  const [initialLoading, setInitialLoading] = useState(true);
  const [resolvingDebt, setResolvingDebt] = useState<string | null>(null);

  // â”€â”€â”€ Granular Refresh Functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // These fetch only the data that changed, avoiding full-page reload

  const refreshSummaries = useCallback(async () => {
    const res = await getUsersSummary();
    if (res.success && res.data) {
      setSummaries(res.data);
      setUsers(res.data.map((s) => s.user));
    }
  }, []);

  const refreshTransactions = useCallback(async () => {
    const res = await getRecentTransactions(10);
    if (res.success && res.data) setTransactions(res.data);
  }, []);

  const refreshCategories = useCallback(async () => {
    const res = await getCategories();
    if (res.success && res.data) setCategories(res.data);
  }, []);

  const refreshBudgets = useCallback(async () => {
    const res = await getBudgetStatus();
    if (res.success && res.data) setBudgets(res.data);
  }, []);

  const refreshDebts = useCallback(async () => {
    const res = await getDebts();
    if (res.success && res.data) setDebts(res.data);
  }, []);

  // Full initial load (only on first mount)
  const fetchAll = useCallback(async () => {
    setInitialLoading(true);
    try {
      const [summaryRes, txRes, catRes, budgetRes, debtRes, profileRes] = await Promise.all(
        [
          getUsersSummary(),
          getRecentTransactions(10),
          getCategories(),
          getBudgetStatus(),
          getDebts(),
          getUserProfile(),
        ]
      );

      if (summaryRes.success && summaryRes.data) {
        setSummaries(summaryRes.data);
        setUsers(summaryRes.data.map((s) => s.user));
      }
      if (txRes.success && txRes.data) setTransactions(txRes.data);
      if (catRes.success && catRes.data) setCategories(catRes.data);
      if (budgetRes.success && budgetRes.data) setBudgets(budgetRes.data);
      if (debtRes.success && debtRes.data) setDebts(debtRes.data);
      if (profileRes.success && profileRes.data) {
        setCurrentUserId(profileRes.data.id);
      }
    } catch (error) {
      console.error('Failed to fetch data:', error);
    }
    setInitialLoading(false);
  }, []);

  useEffect(() => {
    fetchAll();
  }, [fetchAll]);

  // â”€â”€â”€ Handlers (granular refresh) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const handleTransactionSuccess = useCallback(() => {
    // After adding a transaction: refresh summaries (balance changed),
    // transactions list, and budgets (spending may have changed)
    Promise.all([refreshSummaries(), refreshTransactions(), refreshBudgets()]);
  }, [refreshSummaries, refreshTransactions, refreshBudgets]);

  const handleResolveDebt = useCallback(async (debtId: string) => {
    setResolvingDebt(debtId);
    const result = await resolveDebt(debtId);
    setResolvingDebt(null);
    if (result.success) {
      // Debt resolved â†’ refresh debts + summaries (balance changed) + transactions (income added)
      Promise.all([refreshDebts(), refreshSummaries(), refreshTransactions()]);
    }
  }, [refreshDebts, refreshSummaries, refreshTransactions]);

  const handleDebtSuccess = useCallback(() => {
    // After adding a debt: only debts changed
    refreshDebts();
  }, [refreshDebts]);

  const handleCategoryUpdate = useCallback(() => {
    // Categories changed â†’ refresh categories + budgets (limits may have changed)
    Promise.all([refreshCategories(), refreshBudgets()]);
  }, [refreshCategories, refreshBudgets]);

  const handleBudgetUpdate = useCallback(() => {
    // Budget limit changed â†’ refresh budgets + categories
    Promise.all([refreshBudgets(), refreshCategories()]);
  }, [refreshBudgets, refreshCategories]);

  const handleSettingsUpdate = useCallback(() => {
    // Settings changed (balance, user info) â†’ refresh summaries
    refreshSummaries();
  }, [refreshSummaries]);

  // â”€â”€â”€ Derived Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const totalIncome = summaries.reduce((sum, s) => sum + s.totalIncome, 0);
  const totalExpense = summaries.reduce((sum, s) => sum + s.totalExpense, 0);
  const totalBalance = summaries.reduce((sum, s) => sum + s.balance, 0);

  // â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // Full-screen Transaction History view
  if (showHistory) {
    return (
      <TransactionHistory
        users={users}
        currentUserId={currentUserId}
        onBack={() => setShowHistory(false)}
      />
    );
  }

  return (
    <div className="min-h-screen bg-background">
      <Header />

      {/* Loading State (only on initial load) */}
      {initialLoading && (
        <div className="flex items-center justify-center py-12">
          <div className="animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full" />
        </div>
      )}

      {/* â•â•â• NOT ENOUGH USERS â•â•â• */}
      {!initialLoading && users.length < 2 && activeTab !== 'settings' && (
        <div className="flex flex-col items-center justify-center py-16 px-6 text-center">
          <div className="w-24 h-24 rounded-full bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center mb-5 shadow-lg">
            <span className="text-5xl">ğŸ‘«</span>
          </div>
          <h2 className="text-xl font-bold text-foreground mb-2">Cáº§n 2 ngÆ°á»i dÃ¹ng</h2>
          <p className="text-sm text-muted-foreground max-w-xs leading-relaxed">
            á»¨ng dá»¥ng cáº§n <strong>2 thÃ nh viÃªn</strong> Ä‘á»ƒ hoáº¡t Ä‘á»™ng.
            Hiá»‡n táº¡i má»›i cÃ³ <strong>{users.length}</strong> ngÆ°á»i Ä‘Äƒng kÃ½.
          </p>
          <p className="text-sm text-muted-foreground mt-3">
            HÃ£y má»i ngÆ°á»i cÃ²n láº¡i táº¡o tÃ i khoáº£n nhÃ©! ğŸ’•
          </p>
          <div className="mt-6 px-4 py-2.5 bg-primary/10 rounded-2xl">
            <p className="text-xs font-medium text-primary">
              â³ Äang chá» thÃªm {2 - users.length} ngÆ°á»i ná»¯a...
            </p>
          </div>
        </div>
      )}

      {/* â•â•â• HOME TAB â•â•â• */}
      {!initialLoading && users.length >= 2 && activeTab === 'home' && (
        <>
          <div className="space-y-4 px-6 py-4">
            {/* Balance Cards */}
            <div className="flex gap-3">
              {summaries.map((s, i) => (
                <BalanceCard
                  key={s.user.id}
                  name={s.user.name}
                  balance={s.balance}
                  income={s.totalIncome}
                  expense={s.totalExpense}
                  avatar={i === 0 ? 'bg-gradient-to-br from-blue-400 to-blue-600' : 'bg-gradient-to-br from-pink-400 to-pink-600'}
                  avatarInitial={s.user.avatar || 'ğŸ‘¤'}
                  avatarUrl={s.user.avatar_url}
                  bgColor={i === 0 ? 'bg-blue-50' : 'bg-pink-50'}
                />
              ))}
            </div>
          </div>

          {/* Tá»•ng quan vá»‘n chung */}
          <CoupleOverview
            totalBalance={totalBalance}
            monthlyIncome={totalIncome}
            monthlyExpense={totalExpense}
          />

          {/* Recent Activities */}
          <RecentActivities transactions={transactions} onViewAll={() => setShowHistory(true)} />
        </>
      )}

      {/* â•â•â• NGÃ‚N SÃCH â•â•â• */}
      {!initialLoading && users.length >= 2 && activeTab === 'budget' && (
        <BudgetOverview budgets={budgets} onUpdate={handleBudgetUpdate} />
      )}

      {/* â•â•â• DANH Má»¤C â•â•â• */}
      {!initialLoading && users.length >= 2 && activeTab === 'categories' && (
        <CategoryManager categories={categories} onUpdate={handleCategoryUpdate} />
      )}

      {/* â•â•â• DEBT TAB â•â•â• */}
      {!initialLoading && users.length >= 2 && activeTab === 'debt' && (() => {
        const myDebts = debts.filter(d => d.user_id === currentUserId);
        const otherDebts = debts.filter(d => d.user_id !== currentUserId);
        const otherUserName = users.find(u => u.id !== currentUserId)?.name || 'Äá»‘i phÆ°Æ¡ng';

        const renderDebtGroup = (debtList: Debt[], canResolve: boolean) => {
          const pending = debtList.filter(d => d.status === 'pending');
          const resolved = debtList.filter(d => d.status === 'resolved');
          return (
            <>
              {pending.length > 0 && (
                <div className="mb-3">
                  <p className="text-[10px] font-semibold text-amber-600 uppercase tracking-wider mb-1.5">
                    ChÆ°a tráº£ ({pending.length})
                  </p>
                  <div className="space-y-2">
                    {pending.map(debt => (
                      <DebtItem
                        key={debt.id}
                        debt={debt}
                        onResolve={canResolve ? handleResolveDebt : () => { }}
                        resolving={resolvingDebt === debt.id}
                        showResolveButton={canResolve}
                      />
                    ))}
                  </div>
                </div>
              )}
              {resolved.length > 0 && (
                <div>
                  <p className="text-[10px] font-semibold text-green-600 uppercase tracking-wider mb-1.5">
                    ÄÃ£ tráº£ ({resolved.length})
                  </p>
                  <div className="space-y-2">
                    {resolved.map(debt => (
                      <DebtItem
                        key={debt.id}
                        debt={debt}
                        onResolve={() => { }}
                        resolving={false}
                        showResolveButton={false}
                      />
                    ))}
                  </div>
                </div>
              )}
              {debtList.length === 0 && (
                <p className="text-xs text-muted-foreground text-center py-3 bg-muted/30 rounded-xl">
                  ChÆ°a cÃ³ khoáº£n ná»£ nÃ o
                </p>
              )}
            </>
          );
        };

        return (
          <div className="px-6 py-4">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-bold text-foreground">ğŸ“’ Sá»• Ná»£</h2>
              <button
                onClick={() => setShowAddDebt(true)}
                className="text-sm font-semibold text-primary bg-primary/10 px-3 py-1.5 rounded-full hover:bg-primary/20 transition-colors active:scale-95"
              >
                + ThÃªm ná»£
              </button>
            </div>

            {/* My debts */}
            <div className="mb-6">
              <h3 className="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2">
                ğŸ“Œ Ná»£ cá»§a tÃ´i
              </h3>
              <div className="bg-card rounded-2xl p-3 border border-border shadow-sm">
                {renderDebtGroup(myDebts, true)}
              </div>
            </div>

            {/* Partner's debts */}
            <div className="mb-6">
              <h3 className="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2">
                ğŸ‘€ Ná»£ cá»§a {otherUserName}
              </h3>
              <div className="bg-card rounded-2xl p-3 border border-border shadow-sm">
                {renderDebtGroup(otherDebts, false)}
              </div>
            </div>
          </div>
        );
      })()}

      {/* â•â•â• CÃ€I Äáº¶T â•â•â• */}
      {!initialLoading && activeTab === 'settings' && (
        <SettingsPanel users={users} onUpdate={handleSettingsUpdate} />
      )}

      {/* Spacer for bottom nav + safe area */}
      <div style={{ height: 'calc(env(safe-area-inset-bottom, 0px) + 80px)' }}></div>

      {/* Bottom Navigation */}
      <BottomNav
        activeTab={activeTab}
        onTabChange={setActiveTab}
        onFabClick={() => setShowAddTx(true)}
      />

      {/* Drawers / Modals */}
      <AddTransactionDrawer
        open={showAddTx}
        onClose={() => setShowAddTx(false)}
        onSuccess={handleTransactionSuccess}
        categories={categories}
        currentUserId={currentUserId}
      />

      <AddDebtDrawer
        open={showAddDebt}
        onClose={() => setShowAddDebt(false)}
        onSuccess={handleDebtSuccess}
        users={users}
        currentUserId={currentUserId}
      />
    </div>
  );
}
